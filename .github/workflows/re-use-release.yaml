name: Re-Useable Release
on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string
      environment:
        default: "staging"
        required: true
        type: string
    secrets:
      GH_PAT:
        required: true

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: false
          token: ${{ secrets.GH_PAT }}

      - name: Set up Python ${{ inputs.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Install Dependencies
        run: uv sync --upgrade-package poly-hammer-utils

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Create Portal Release
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ADDONS_FOLDER: ${{ github.workspace }}/src/addons
          BLENDER_VERSION: "4.5"
          ENVIRONMENT: ${{ inputs.environment }}
          PORTAL_API_KEY: ${{ secrets.POLY_HAMMER_PORTAL_API_KEY }}
        run: uv run python -m poly_hammer_utils.extension.meta_human_dna

      - name: Create Release
        if: github.ref == 'refs/heads/main'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ADDON_FOLDER: src/addons/meta_human_dna
          GITHUB_REPO: ${{ github.repository }}
          CORE_REPO: ${{ secrets.CORE_REPO }}
        run: uv run python -m poly_hammer_utils.addon.release
