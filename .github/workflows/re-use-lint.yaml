name: Re-Useable Lint & Static Analysis
on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string

jobs:
  lint:
    name: Ruff Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv pip install --system ruff

      - name: Ruff Lint Check
        run: |
          ruff check --output-format=github .

      - name: Ruff Format Check
        run: |
          ruff format --check --diff .

  spell-check:
    name: CSpell Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CSpell
        run: npm install -g cspell@latest

      - name: Run CSpell
        run: |
          cspell lint --no-progress --show-suggestions --show-context ./**/*

  type-check:
    name: Pyright Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Create venv and additional stubs venv
        run: |
          uv sync

          uv venv .stubs-venv
          uv pip install --python .stubs-venv/Scripts/python.exe -e ".[stubs]"

      - name: Install pyright
        run: |
          npm install -g pyright

      - name: Run Pyright
        run: |
          pyright --outputjson > pyright-results.json || true
          cat pyright-results.json

      - name: Upload Pyright Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pyright-results
          path: pyright-results.json
          retention-days: 7

  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Install pre-commit
        run: |
          uv pip install --system pre-commit

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1
        with:
          extra_args: --all-files --show-diff-on-failure
        env:
          SKIP: no-commit-to-branch
